<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Controle de Refugo - Fundição Erus</title>

    <style>
        :root {
            --primary-blue: #2c3e50;
            --secondary-blue: #3498db;
            --accent-blue: #2980b9;
            --dark-blue: #1a2530;
            --light-gray: #ecf0f1;
            --medium-gray: #bdc3c7;
            --dark-gray: #7f8c8d;
            --border-color: #95a5a6;
            --success-color: #27ae60;
            --warning-color: #e67e22;
            --danger-color: #c0392b;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Courier New', monospace; }
        body { background: var(--light-gray); color: #333; padding: 15px; line-height: 1.4; font-size: 14px; display: flex; flex-direction: column; min-height: 100vh; }
        .container { max-width: 1600px; margin: 0 auto; background: #fff; border-radius: 4px; box-shadow: 0 0 15px rgba(0,0,0,0.1); overflow: hidden; border: 1px solid var(--border-color); flex: 1; display: flex; flex-direction: column; height: calc(100vh - 30px); }
        header { background: var(--primary-blue); color: #fff; padding: 15px 20px; text-align: center; border-bottom: 3px solid var(--secondary-blue); flex-shrink: 0; position: relative; }
        h1 { font-size: 18px; margin-bottom: 3px; letter-spacing: 0.5px; }
        p.subtitle { margin-top: 4px; color: var(--light-gray); font-size: 12px; }
        .header-button { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); }
        
        /* Indicadores acima dos gráficos */
        .indicators-container { padding: 15px; background: var(--light-gray); border-bottom: 1px solid var(--border-color); flex-shrink: 0; display: flex; gap: 15px; flex-wrap: wrap; }
        .indicator-card { flex: 1; min-width: 180px; background: white; border-radius: 4px; box-shadow: 0 0 10px rgba(0,0,0,0.05); padding: 15px; border: 1px solid var(--border-color); text-align: center; }
        .indicator-title { font-size: 12px; color: var(--dark-blue); font-weight: bold; margin-bottom: 5px; }
        .indicator-value { font-size: 18px; font-weight: 700; color: var(--primary-blue); }
        .indicator-subvalue { font-size: 12px; color: var(--dark-gray); margin-top: 3px; }
        
        /* Gráficos */
        .charts-container { padding: 20px 15px; background: #f9f9f9; border-bottom: 1px solid var(--border-color); flex-shrink: 0; display: flex; flex-direction: column; gap: 20px; }
        .chart-row { display: flex; gap: 20px; width: 100%; }
        .chart-box { flex: 1; background: white; border-radius: 4px; box-shadow: 0 0 10px rgba(0,0,0,0.05); padding: 15px; border: 1px solid var(--border-color); min-width: 300px; }
        .chart-title { text-align: center; margin-bottom: 15px; font-weight: bold; color: var(--dark-blue); }
        .chart-wrapper { height: 250px; }
        
        /* Estilos do formulário */
        .form-container { padding: 15px; background: #f9f9f9; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .form-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; align-items: flex-end; }
        .form-group { flex: 1; min-width: 150px; }
        .form-group label { display: block; font-size: 12px; margin-bottom: 4px; font-weight: bold; color: var(--dark-blue); }
        .form-group input, .form-group select { width: 100%; padding: 6px 8px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 12px; background: white; font-family: 'Courier New', monospace; text-transform: uppercase; }
        .form-buttons { display: flex; gap: 8px; justify-content: flex-end; margin-top: 5px; }
        
        .date-filter-container { background-color: var(--light-gray); padding: 15px; border-bottom: 1px solid var(--border-color); }
        .date-filter-container .form-group input { min-width: 120px; }
        
        .controls { padding: 10px 15px; display: flex; gap: 8px; align-items: center; justify-content: space-between; background: var(--light-gray); flex-wrap: wrap; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .left-controls { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
        input[type="text"], input[type="date"], input[type="number"] { padding: 6px 8px; border: 1px solid var(--border-color); border-radius: 3px; font-size: 12px; background: white; font-family: 'Courier New', monospace; text-transform: uppercase; }
        
        /* Estilos gerais de botões */
        button { padding: 6px 10px; border: 1px solid var(--dark-blue); border-radius: 3px; cursor: pointer; background: var(--secondary-blue); color: #fff; transition: background .15s; font-size: 12px; font-weight: bold; }
        button:hover { background: var(--accent-blue); }
        
        /* Botões com cores específicas */
        .btn-add { background: var(--warning-color); border-color: #bf6516; }
        .btn-add:hover { background: #d35400; }
        .btn-danger { background: var(--danger-color); border-color: #922b21; }
        .btn-danger:hover { background: #a93226; }
        .btn-default { background: var(--dark-gray); border-color: #6c7a81; }
        .btn-default:hover { background: #6c7a81; }

        .table-container { overflow: auto; flex: 1; min-height: 300px; }
        table { width: 100%; border-collapse: collapse; min-width: 100px; font-size: 12px; }
        th, td { padding: 8px 10px; border-bottom: 1px solid var(--border-color); text-align: left; text-transform: uppercase; }
        thead tr.header-row th { background: var(--dark-blue); color: white; position: sticky; top: 0; z-index: 20; font-weight: 600; font-size: 12px; padding: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        thead tr.filter-row th { background: var(--medium-gray); padding: 6px; position: sticky; top: 40px; z-index: 15; }
        thead tr.filter-row input { width: 100%; padding: 4px 6px; box-sizing: border-box; border-radius: 2px; border: 1px solid var(--border-color); font-size: 11px; text-transform: uppercase; }
        tr:nth-child(even) td { background: #f8f9f9; }
        tr:hover td { background: #eaf2f8; }
        .center { text-align: center; }
        .checkbox-cell { width: 70px; }
        .delete-cell { width: 30px; }
        .delete-btn { color: var(--danger-color); cursor: pointer; font-weight: bold; text-align: center; }
        .delete-btn:hover { color: #ff0000; }
        
        .footer { padding: 10px 15px; background: var(--primary-blue); display: flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap; border-top: 3px solid var(--secondary-blue); color: white; flex-shrink: 0; }
        .status { font-size: 12px; color: #fff; font-weight: bold; }
        .panel-totals { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .panel-card { background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2); padding: 6px 10px; border-radius: 3px; min-width: 140px; text-align: center; box-shadow: 0 2px 3px rgba(0,0,0,0.1); color: white; }
        .panel-card .label { font-size: 11px; color: var(--light-gray); font-weight: bold; }
        .panel-card .value { font-size: 14px; font-weight: 700; margin-top: 4px; color: #fff; }
        
        /* CORREÇÃO 2: Container dos botões do rodapé */
        .footer > div:last-of-type { display: flex; gap: 8px; align-items: center; }

        /* CORREÇÃO 2: Unifica o estilo dos botões e da label no rodapé para terem o mesmo tamanho */
        .footer button, .footer .btn-import {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 10px;
            border: 1px solid var(--dark-blue);
            border-radius: 3px;
            cursor: pointer;
            background: var(--secondary-blue);
            color: #fff;
            transition: background .15s;
            font-size: 12px;
            font-weight: bold;
            text-decoration: none;
            line-height: 1.4;
        }
        /* Assegura que o hover genérico seja aplicado a ambos */
        .footer button:hover, .footer .btn-import:hover {
            background: var(--accent-blue);
        }
        /* Restaura a cor específica do botão de perigo */
        .footer .btn-danger {
            background: var(--danger-color);
            border-color: #922b21;
        }
        .footer .btn-danger:hover {
            background: #a93226;
        }

        .scroll-btn { position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; border-radius: 50%; background: var(--secondary-blue); color: white; border: none; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: all 0.3s ease; }
        .scroll-btn:hover { background: var(--accent-blue); transform: translateY(-3px); }
        
        @media (max-width: 900px) { 
            body{padding:10px;font-size:13px} 
            .container{border-radius:3px;height:calc(100vh - 20px)} 
            .date-filter-container .form-row { flex-direction: column; align-items: stretch; }
            .indicators-container, .charts-container { flex-direction: column; padding: 15px 10px; }
            .chart-row { flex-direction: column; }
            .indicator-card { min-width: 100%; }
            .form-container{padding:10px} 
            .controls{padding:8px 10px} 
            .table-container{min-height: 250px;}
            thead tr.filter-row th{top:39px} 
            .footer{padding:8px 10px} 
            .panel-card{min-width:120px;padding:5px 8px} 
            .panel-card .value{font-size:13px} 
            .scroll-btn { bottom: 20px; right: 20px; width: 40px; height: 40px; font-size: 16px; }
        }
        @media (max-width: 600px) { 
            body{padding:5px} 
            .container{height:calc(100vh - 10px)} 
            .table-container{min-height: 200px;}
            thead tr.filter-row th{top:39px} 
            .left-controls,.controls{gap:4px} 
            button{padding:5px 8px;font-size:11px} 
            input[type="text"]{max-width:120px} 
            .panel-totals{gap:5px} 
            .panel-card{min-width:100px;padding:4px 6px} 
            .panel-card .label{font-size:10px} 
            .panel-card .value{font-size:12px} 
            .scroll-btn { bottom: 15px; right: 15px; width: 35px; height: 35px; font-size: 14px; }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>CONTROLE DE REFUGO - FUNDIÇÃO ERUS</h1>
        <p class="subtitle">Tabela de apontamentos de refugo</p>
        <div class="header-button">
            <button onclick="window.location.href='dashboard.html'">Sistema</button>
        </div>
    </header>

    <div class="date-filter-container">
        <div class="form-row">
            <div class="form-group" style="flex:none;">
                <label for="inputDataInicial">Data Inicial</label>
                <input type="date" id="inputDataInicial">
            </div>
            <div class="form-group" style="flex:none;">
                <label for="inputDataFinal">Data Final</label>
                <input type="date" id="inputDataFinal">
            </div>
            <div style="display:flex; gap: 8px;">
                <button class="btn-primary" onclick="applyAllFilters()">Filtrar</button>
                <button class="btn-default" onclick="clearDateFilter()">Limpar Datas</button>
                <button class="btn-default" onclick="clearChartFilter()" id="clearChartFilterBtn" style="display:none;">Limpar Filtro do Gráfico</button>
            </div>
        </div>
    </div>
    
    <div class="indicators-container">
        <div class="indicator-card">
            <div class="indicator-title">QUANTIDADE TOTAL</div>
            <div id="indicatorQuantity" class="indicator-value">0</div>
        </div>
        <div class="indicator-card">
            <div class="indicator-title">PESO TOTAL (kg)</div>
            <div id="indicatorWeight" class="indicator-value">0,00</div>
        </div>
        <div class="indicator-card">
            <div class="indicator-title">PESO MÉDIO (kg)</div>
            <div id="indicatorAvgWeight" class="indicator-value">0,00</div>
        </div>
        <div class="indicator-card">
            <div class="indicator-title">REFUGO / PRODUÇÃO</div>
            <div id="indicatorRefugoProducao" class="indicator-value">0,00%</div>
            <div class="indicator-subvalue">Produção: 24.089,80 kg</div>
        </div>
    </div>

    <div class="charts-container">
        <div class="chart-box">
            <div class="chart-title">Peso Total Refugado por Dia (kg)</div>
            <div class="chart-wrapper" style="height: 220px;"> <canvas id="dailyChart"></canvas>
            </div>
        </div>
        
        <div class="chart-row">
            <div class="chart-box">
                <div class="chart-title">Principais Causas de Refugo por Peso (kg)</div>
                <div class="chart-wrapper">
                    <canvas id="scrapChart"></canvas>
                </div>
            </div>
            <div class="chart-box">
                <div class="chart-title">Refugo por Setor (kg)</div>
                <div class="chart-wrapper">
                    <canvas id="sectorChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="form-container">
        <div class="form-row">
            <div class="form-group">
                <label for="inputData">DATA</label>
                <input type="date" id="inputData" value="">
            </div>
            <div class="form-group">
                <label for="inputCodigo">CÓDIGO</label>
                <input type="text" id="inputCodigo" placeholder="Código do produto">
            </div>
            <div class="form-group">
                <label for="inputDescricao">DESCRIÇÃO</label>
                <input type="text" id="inputDescricao" placeholder="Descrição do produto">
            </div>
            <div class="form-group">
                <label for="inputMaterial">MATERIAL</label>
                <input type="text" id="inputMaterial" placeholder="Material">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="inputQuantidade">QUANTIDADE</label>
                <input type="number" id="inputQuantidade" placeholder="0" min="1" step="1">
            </div>
            <div class="form-group">
                <label for="inputPesoUn">PESO (UN) kg</label>
                <input type="number" id="inputPesoUn" placeholder="0.00" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label for="inputCausa">CAUSA</label>
                <select id="inputCausa">
                    <option value="">Selecione a causa...</option>
                    <option value="BOLHA DE GÁS">BOLHA DE GÁS</option>
                    <option value="CAIXA ARRISCADA">CAIXA ARRISCADA</option>
                    <option value="CAIXA VAZADA">CAIXA VAZADA</option>
                    <option value="CORTE/QUEBRA DE CANAL INCORRETO">CORTE/QUEBRA DE CANAL INCORRETO</option>
                    <option value="DANIFICADA NO ACABAMENTO">DANIFICADA NO ACABAMENTO</option>
                    <option value="DESLOCAMENTO">DESLOCAMENTO</option>
                    <option value="DIMENSIONAL">DIMENSIONAL</option>
                    <option value="DUREZA NÃO CONFORME">DUREZA NÃO CONFORME</option>
                    <option value="EMPENAMENTO">EMPENAMENTO</option>
                    <option value="ENGROSSAMENTO - FALTA PESO">ENGROSSAMENTO - FALTA PESO</option>
                    <option value="ENGROSSAMENTO - FOLGA MACHO">ENGROSSAMENTO - FOLGA MACHO</option>
                    <option value="ERRO OPERACIONAL">ERRO OPERACIONAL</option>
                    <option value="ERRO PROJETO MODELO">ERRO PROJETO MODELO</option>
                    <option value="EXCESSO DE REBARBA">EXCESSO DE REBARBA</option>
                    <option value="FECHAMENTO MOLDE INVERTIDO">FECHAMENTO MOLDE INVERTIDO</option>
                    <option value="FERVEU">FERVEU</option>
                    <option value="FUNDIDO NA LIGA ERRADA">FUNDIDO NA LIGA ERRADA</option>
                    <option value="FUNDIDO SEM LUVA">FUNDIDO SEM LUVA</option>
                    <option value="FUNDIDO SEM MACHO">FUNDIDO SEM MACHO</option>
                    <option value="IDENTIFICAÇÃO SEM NUMEROS E/OU LETRAS">IDENTIFICAÇÃO SEM NUMEROS E/OU LETRAS</option>
                    <option value="INCLUSÃO DE AREIA">INCLUSÃO DE AREIA</option>
                    <option value="INCLUSÃO DE ESCORIA">INCLUSÃO DE ESCORIA</option>
                    <option value="MACHO DESLOCADO">MACHO DESLOCADO</option>
                    <option value="MACHO INVERTIDO">MACHO INVERTIDO</option>
                    <option value="MODELO">MODELO</option>
                    <option value="MOLDE MAL COMPACTADO">MOLDE MAL COMPACTADO</option>
                    <option value="PEÇA DANIFICADA NA REBARBAÇÃO">PEÇA DANIFICADA NA REBARBAÇÃO</option>
                    <option value="PEÇA NÃO ENCONTRADA">PEÇA NÃO ENCONTRADA</option>
                    <option value="POROSIDADE">POROSIDADE</option>
                    <option value="QUEBRA DE PEÇA">QUEBRA DE PEÇA</option>
                    <option value="QUEBRA DE CAIXA DE MOLDE">QUEBRA DE CAIXA DE MOLDE</option>
                    <option value="QUEBRA DE MACHO">QUEBRA DE MACHO</option>
                    <option value="QUEBRA DE MOLDE">QUEBRA DE MOLDE</option>
                    <option value="REAÇÃO METAL/MOLDE">REAÇÃO METAL/MOLDE</option>
                    <option value="RECHUPE">RECHUPE</option>
                    <option value="SINTERIZAÇÃO">SINTERIZAÇÃO</option>
                    <option value="SOLDA FRIA">SOLDA FRIA</option>
                    <option value="TRATAMENTO TERMICO">TRATAMENTO TERMICO</option>
                    <option value="TRINCA DE FUNDIÇÃO">TRINCA DE FUNDIÇÃO</option>
                    <option value="TRINCA DE TRATAMENTO TERMICO">TRINCA DE TRATAMENTO TERMICO</option>
                </select>
            </div>
            <div class="form-group">
                <label for="inputSetor">SETOR RESPONSÁVEL</label>
                <select id="inputSetor">
                    <option value="">Selecione...</option>
                    <option value="FUNDIÇÃO">FUNDIÇÃO</option>
                    <option value="MOLDAGEM">MOLDAGEM</option>
                    <option value="ACABAMENTO">ACABAMENTO</option>
                    <option value="CONTROLE DE QUALIDADE">CONTROLE DE QUALIDADE</option>
                    <option value="EXPEDIÇÃO">EXPEDIÇÃO</option>
                    <option value="OUTRO">OUTRO</option>
                </select>
            </div>
        </div>
        
        <div class="form-buttons">
            <button class="btn-add" onclick="adicionarRefugo()">Adicionar Refugo</button>
            <button class="btn-danger" onclick="limparFormulario()">Limpar</button>
        </div>
    </div>

    <div class="controls">
        <div class="left-controls">
        </div>
        <div style="display:flex; gap:6px; align-items:center;">
        </div>
    </div>

    <div class="table-container">
        <table id="scrapTable" role="table" aria-label="Tabela de refugo">
            <thead>
                <tr class="header-row">
                    <th class="delete-cell"></th>
                    <th class="checkbox-cell center">APONT.</th>
                    <th>DATA</th>
                    <th>CÓDIGO</th>
                    <th>DESCRIÇÃO</th>
                    <th>MATERIAL</th>
                    <th>QUANTIDADE</th>
                    <th>PESO (UN)</th>
                    <th>PESO TOTAL</th>
                    <th>CAUSA</th>
                    <th>SETOR RESPONSÁVEL</th>
                </tr>
                <tr class="filter-row">
                    <th></th>
                    <th></th> <th><input data-col="2" placeholder="Filtrar"/></th>
                    <th><input data-col="3" placeholder="Filtrar"/></th>
                    <th><input data-col="4" placeholder="Filtrar"/></th>
                    <th><input data-col="5" placeholder="Filtrar"/></th>
                    <th><input data-col="6" placeholder="Filtrar"/></th>
                    <th><input data-col="7" placeholder="Filtrar"/></th>
                    <th><input data-col="8" placeholder="Filtrar"/></th>
                    <th><input data-col="9" placeholder="Filtrar"/></th>
                    <th><input data-col="10" placeholder="Filtrar"/></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="footer">
        <div class="status">Total de apontamentos: <strong id="totalRows">0</strong></div>
        <div class="panel-totals">
            <div class="panel-card">
                <div class="label">Quantidade Total</div>
                <div id="totalQuantity" class="value">0</div>
            </div>
            <div class="panel-card">
                <div class="label">Peso Total (kg)</div>
                <div id="totalWeight" class="value">0,00</div>
            </div>
            <div class="panel-card">
                <div class="label">Peso Médio (kg)</div>
                <div id="avgWeight" class="value">0,00</div>
            </div>
        </div>
        <div>
            <button onclick="exportCSV()" title="Exportar CSV">Exportar CSV</button>
            <label for="csvFileInput" class="btn-import">Importar CSV</label>
            <input type="file" id="csvFileInput" accept=".csv" style="display:none;">
            <button onclick="limparTodosDados()" title="Limpar todos os dados" class="btn-danger">Limpar Dados</button>
        </div>
    </div>
</div>

<button class="scroll-btn" id="scrollBtn" title="Ir para a tabela">↓</button>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<script>
    const PRODUCAO_TOTAL = 24089.80;
    
    let scrapChart = null;
    let dailyChart = null;
    let sectorChart = null;
    
    let scrollBtn = document.getElementById('scrollBtn');
    let registros = [];
    let activeChartFilter = { type: null, value: null };

    async function apiRequest(endpoint, method = 'GET', data = null) {
        const options = {
            method: method,
            headers: { 'Content-Type': 'application/json' }
        };
        if (data && (method === 'POST' || method === 'PUT')) {
            options.body = JSON.stringify(data);
        }
        try {
            const response = await fetch(`/api/${endpoint}`, options);
            if (!response.ok) throw new Error(`Erro na requisição: ${response.status}`);
            return await response.json();
        } catch (error) {
            console.error('Erro na comunicação com o servidor:', error);
            alert('Erro na comunicação com o servidor. Verifique se o servidor está rodando.');
            throw error;
        }
    }
    function definirDataAtual(elemento) {
        const hoje = new Date();
        elemento.value = hoje.toISOString().split('T')[0];
    }
    function setDefaultFilterDates() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        document.getElementById('inputDataInicial').value = firstDay.toISOString().split('T')[0];
        document.getElementById('inputDataFinal').value = lastDay.toISOString().split('T')[0];
    }
    function clearDateFilter() {
        document.getElementById('inputDataInicial').value = '';
        document.getElementById('inputDataFinal').value = '';
        applyAllFilters();
    }
    function clearChartFilter() {
        activeChartFilter = { type: null, value: null };
        document.getElementById('clearChartFilterBtn').style.display = 'none';
        applyAllFilters();
    }
    function applyAllFilters() {
        const initialDateStr = document.getElementById('inputDataInicial').value;
        const finalDateStr = document.getElementById('inputDataFinal').value;
        let filteredRegistros = [...registros];
        if (initialDateStr && finalDateStr) {
            const initialDate = new Date(initialDateStr + 'T00:00:00');
            const finalDate = new Date(finalDateStr + 'T23:59:59');
            if (initialDate > finalDate) {
                alert('A Data Inicial não pode ser posterior à Data Final.');
                return;
            }
            filteredRegistros = filteredRegistros.filter(reg => {
                const regDate = new Date(reg.data + 'T00:00:00');
                return regDate >= initialDate && regDate <= finalDate;
            });
        }
        if (activeChartFilter.value) {
            document.getElementById('clearChartFilterBtn').style.display = 'inline-block';
            const { type, value } = activeChartFilter;
            if (type === 'causa') {
                filteredRegistros = filteredRegistros.filter(r => r.causa === value);
            } else if (type === 'setor') {
                filteredRegistros = filteredRegistros.filter(r => r.setor === value);
            } else if (type === 'data') {
                const parts = value.split('/');
                const dateToFilter = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                filteredRegistros = filteredRegistros.filter(r => r.data === dateToFilter);
            }
        } else {
             document.getElementById('clearChartFilterBtn').style.display = 'none';
        }
        updateUI(filteredRegistros);
    }
    async function adicionarRefugo() {
        const data = document.getElementById('inputData').value;
        const codigo = document.getElementById('inputCodigo').value.toUpperCase();
        const descricao = document.getElementById('inputDescricao').value.toUpperCase();
        const material = document.getElementById('inputMaterial').value.toUpperCase();
        const quantidade = document.getElementById('inputQuantidade').value;
        const pesoUn = document.getElementById('inputPesoUn').value;
        const causa = document.getElementById('inputCausa').value;
        const setor = document.getElementById('inputSetor').value.toUpperCase();
        if (!data || !codigo || !quantidade || !pesoUn || !causa || !setor) {
            alert('Por favor, preencha os campos obrigatórios.');
            return;
        }
        try {
            const registro = { data, codigo, descricao, material, causa, setor, quant: parseInt(quantidade), peso: parseNumberSafe(pesoUn), tipo: "refugo" };
            const response = await apiRequest('registros', 'POST', registro);
            if (response.success) {
                registro.id = response.id;
                registro.peso_total = registro.peso * registro.quant;
                registros.push(registro);
                applyAllFilters();
                limparFormulario();
                alert('Refugo adicionado com sucesso!');
            } else {
                alert('Erro ao adicionar refugo: ' + (response.error || 'Erro desconhecido'));
            }
        } catch (error) { console.error('Erro ao adicionar refugo:', error); }
    }
    function updateUI(filteredData) {
        updateTable(filteredData);
        updateCounters(filteredData);
        updateCharts(filteredData);
        applyColumnFilters();
    }
    function updateTable(filteredData){
        const tbody = document.querySelector('#scrapTable tbody');
        tbody.innerHTML = '';
        filteredData.forEach(registro => {
            const tr = document.createElement('tr');
            tr.dataset.id = String(registro.id);
            const dataObj = new Date(registro.data + 'T00:00:00');
            const dataFormatada = dataObj.toLocaleDateString('pt-BR');
            const pesoTotal = registro.peso_total || (registro.peso * registro.quant);
            tr.innerHTML = `<td class="delete-cell center"><span class="delete-btn" title="Excluir">X</span></td><td class="center checkbox-cell"><input type="checkbox" title="Apontado" ${registro.apontado ? 'checked' : ''}></td><td>${dataFormatada}</td><td>${registro.codigo}</td><td>${registro.descricao}</td><td>${registro.material}</td><td style="text-align: right;">${registro.quant}</td><td style="text-align: right;">${formatNumber(registro.peso)}</td><td style="text-align: right;">${formatNumber(pesoTotal)}</td><td>${registro.causa}</td><td>${registro.setor}</td>`;
            tr.querySelector('.delete-btn').onclick = () => excluirRegistro(registro.id, tr);
            tr.querySelector('input[type="checkbox"]').onchange = (e) => salvarAlteracoes(registro.id, 'apontado', e.target.checked);
            tbody.appendChild(tr);
        });
    }
    async function salvarAlteracoes(id, campo, novoValor) {
        try {
            const registro = registros.find(r => r.id === id);
            if (!registro) return;
            const updates = { [campo]: campo === 'apontado' ? (novoValor ? 1 : 0) : novoValor };
            const response = await apiRequest('update', 'POST', { id, updates });
            if (response.success) {
                Object.assign(registro, updates);
            } else {
                alert('Erro ao salvar: ' + (response.error || ''));
                applyAllFilters();
            }
        } catch (error) { console.error('Erro ao salvar:', error); }
    }
    async function excluirRegistro(id, trElement) {
        if (!confirm('Deseja excluir este refugo?')) return;
        try {
            const response = await apiRequest('delete', 'POST', { id });
            if (response.success) {
                registros = registros.filter(r => r.id !== id);
                trElement.remove();
                applyAllFilters();
                alert('Refugo excluído!');
            } else {
                alert('Erro ao excluir: ' + (response.error || ''));
            }
        } catch (error) { console.error('Erro ao excluir:', error); }
    }
    function formatNumber(value){
        if (value === null || value === undefined || isNaN(value)) return '0,00';
        return Number(value).toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2});
    }
    function parseNumberSafe(text){
        if (text === null || text === undefined) return 0;
        let s = String(text).trim().replace(',', '.');
        const num = parseFloat(s);
        return isNaN(num) ? 0 : num;
    }
    function updateCounters(dataToProcess){
        let totalQty = dataToProcess.reduce((sum, r) => sum + (r.quant || 0), 0);
        let totalWeight = dataToProcess.reduce((sum, r) => sum + (r.peso_total || (r.peso * r.quant)), 0);
        document.getElementById('totalRows').textContent = dataToProcess.length;
        document.getElementById('totalQuantity').textContent = Number(totalQty).toLocaleString('pt-BR');
        document.getElementById('totalWeight').textContent = formatNumber(totalWeight);
        document.getElementById('avgWeight').textContent = formatNumber(totalQty === 0 ? 0 : totalWeight / totalQty);
        document.getElementById('indicatorQuantity').textContent = Number(totalQty).toLocaleString('pt-BR');
        document.getElementById('indicatorWeight').textContent = formatNumber(totalWeight);
        document.getElementById('indicatorAvgWeight').textContent = formatNumber(totalQty === 0 ? 0 : totalWeight / totalQty);
        const porcentagemRefugo = totalWeight > 0 ? (totalWeight / PRODUCAO_TOTAL) * 100 : 0;
        document.getElementById('indicatorRefugoProducao').textContent = formatNumber(porcentagemRefugo) + '%';
    }
    function limparFormulario() {
        ['inputCodigo', 'inputDescricao', 'inputMaterial', 'inputQuantidade', 'inputPesoUn'].forEach(id => document.getElementById(id).value = '');
        ['inputCausa', 'inputSetor'].forEach(id => document.getElementById(id).selectedIndex = 0);
    }
    function updateCharts(dataToProcess) {
        updateScrapChart(dataToProcess);
        updateSectorChart(dataToProcess);
        updateDailyChart(dataToProcess);
    }
    function handleChartClick(event, elements, filterType) {
        if (elements.length > 0) {
            const chart = elements[0].chart;
            const index = elements[0].index;
            const clickedValue = chart.data.labels[index];
            if (activeChartFilter.type === filterType && activeChartFilter.value === clickedValue) {
                clearChartFilter();
            } else {
                activeChartFilter = { type: filterType, value: clickedValue };
                applyAllFilters();
            }
        }
    }
    function updateScrapChart(data) {
        const causas = data.reduce((acc, r) => { const c = r.causa || 'OUTRA'; acc[c] = (acc[c] || 0) + (r.peso_total || r.peso * r.quant); return acc; }, {});
        const s = Object.entries(causas).sort((a, b) => b[1] - a[1]).slice(0, 8);
        const l = s.map(i => i[0]), d = s.map(i => i[1]), t = d.reduce((a, v) => a + v, 0);
        if (scrapChart) scrapChart.destroy();
        scrapChart = new Chart(document.getElementById('scrapChart').getContext('2d'), { type: 'pie', data: { labels: l, datasets: [{ data: d, backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#8dd3c7', '#fdb462'] }] }, options: { responsive: true, maintainAspectRatio: false, onClick: (e, el) => handleChartClick(e, el, 'causa'), plugins: { datalabels: { display: false }, legend: { position: 'right', labels: { font: { size: 10 } } }, tooltip: { callbacks: { label: (c) => `${c.label}: ${formatNumber(c.raw)} kg (${t > 0 ? ((c.raw / t) * 100).toFixed(1) : 0}%)` } } } } });
    }
    function updateSectorChart(data) {
        const setores = data.reduce((acc, r) => { const s = r.setor || 'N/D'; acc[s] = (acc[s] || 0) + (r.peso_total || r.peso * r.quant); return acc; }, {});
        const s = Object.entries(setores).sort((a, b) => b[1] - a[1]);
        const l = s.map(i => i[0]), d = s.map(i => i[1]);
        if (sectorChart) sectorChart.destroy();
        sectorChart = new Chart(document.getElementById('sectorChart').getContext('2d'), { type: 'pie', data: { labels: l, datasets: [{ data: d, backgroundColor: ['#27ae60', '#e67e22', '#c0392b', '#7f8c8d', '#f1c40f', '#8e44ad'] }] }, options: { responsive: true, maintainAspectRatio: false, onClick: (e, el) => handleChartClick(e, el, 'setor'), plugins: { datalabels: { display: false }, legend: { position: 'right', labels: { font: { size: 10 } } }, tooltip: { callbacks: { label: (c) => `${c.label}: ${formatNumber(c.raw)} kg (${PRODUCAO_TOTAL > 0 ? ((c.raw / PRODUCAO_TOTAL) * 100).toFixed(2) : 0}%)` } } } } });
    }
    function updateDailyChart(data) {
        const dias = {}; data.forEach(r => { const dF = new Date(r.data + 'T00:00:00').toLocaleDateString('pt-BR'); dias[dF] = (dias[dF] || 0) + (r.peso_total || r.peso * r.quant); });
        const s = Object.entries(dias).sort((a, b) => new Date(a[0].split('/').reverse().join('-')) - new Date(b[0].split('/').reverse().join('-')));
        const l = s.map(i => i[0]), d = s.map(i => i[1]);
        if (dailyChart) dailyChart.destroy();
        dailyChart = new Chart(document.getElementById('dailyChart').getContext('2d'), { type: 'bar', data: { labels: l, datasets: [{ label: 'Peso (kg)', data: d, backgroundColor: '#36A2EB' }] }, options: { responsive: true, maintainAspectRatio: false, onClick: (e, el) => handleChartClick(e, el, 'data'), scales: { y: { beginAtZero: true }, x: { ticks: { font: { size: 10 } } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `Peso: ${formatNumber(c.raw)} kg` } }, datalabels: { anchor: 'end', align: 'top', formatter: (v) => formatNumber(v), color: '#444', font: { weight: 'bold', size: 10 } } } } });
    }
    function applyColumnFilters() {
        const inputs = document.querySelectorAll('thead .filter-row input'); const filters = Array.from(inputs).map(i => ({ col: i.dataset.col, val: i.value.trim().toUpperCase() }));
        document.querySelectorAll('#scrapTable tbody tr').forEach(row => { let visible = true; for (const filter of filters) { if (!filter.val) continue; const cell = row.cells[filter.col]; if (!cell || !cell.textContent.toUpperCase().includes(filter.val)) { visible = false; break; } } row.style.display = visible ? '' : 'none'; });
    }
    function exportCSV(){
        const h = ['APONT.','DATA','CÓDIGO','DESCRIÇÃO','MATERIAL','QUANTIDADE','PESO (UN)','PESO TOTAL','CAUSA','SETOR RESPONSÁVEL'].join(';');
        const r = Array.from(document.querySelectorAll('#scrapTable tbody tr:not([style*="none"])')).map(row => { const reg = registros.find(r => String(r.id) === row.dataset.id); if (!reg) return ''; const dF = new Date(reg.data + 'T00:00:00').toLocaleDateString('pt-BR'); const pT = reg.peso_total || reg.peso * reg.quant; return [reg.apontado ? '1' : '0', dF, `"${reg.codigo}"`, `"${reg.descricao}"`, `"${reg.material}"`, reg.quant, String(reg.peso).replace('.',','), String(pT).replace('.',','), `"${reg.causa}"`, `"${reg.setor}"`].join(';'); });
        const csv = [h, ...r].join('\n'); const blob = new Blob(["\uFEFF" + csv], {type: 'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'controle_refugo.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }
    async function importCSV(event) {
        const file = event.target.files[0];
        if (!file) { return; }
        if (!file.name.endsWith('.csv')) { alert('Por favor, selecione um arquivo CSV.'); return; }
        const reader = new FileReader();
        reader.onload = async function (e) {
            const text = e.target.result;
            const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            if (lines.length <= 1) { alert('O arquivo CSV está vazio ou não contém dados.'); return; }
            const headers = lines[0].split(';');
            const expectedHeaders = ["APONT.", "DATA", "CÓDIGO", "DESCRIÇÃO", "MATERIAL", "QUANTIDADE", "PESO (UN)", "PESO TOTAL", "CAUSA", "SETOR RESPONSÁVEL"];
            if (!expectedHeaders.every(header => headers.includes(header))) { alert('O arquivo CSV não possui as colunas esperadas. Verifique o cabeçalho.'); return; }
            const dataRows = lines.slice(1);
            let importCount = 0; let errorCount = 0;
            for (const line of dataRows) {
                const values = line.split(';').map(v => v.replace(/"/g, ''));
                const record = { apontado: values[0] === '1', data: values[1].split('/').reverse().join('-'), codigo: values[2], descricao: values[3], material: values[4], quant: parseInt(values[5]), peso: parseNumberSafe(values[6]), causa: values[8], setor: values[9], tipo: "refugo" };
                if (!record.data || !record.codigo || isNaN(record.quant) || isNaN(record.peso)) { console.error('Dados inválidos na linha:', record); errorCount++; continue; }
                try {
                    const response = await apiRequest('registros', 'POST', record);
                    if (response.success) { importCount++; } else { errorCount++; console.error('Erro ao importar linha:', response.error); }
                } catch (err) { errorCount++; console.error('Erro de API ao importar:', err); }
            }
            alert(`Importação concluída: ${importCount} registros importados com sucesso. ${errorCount} com erros.`);
            document.getElementById('csvFileInput').value = '';
            carregarDados();
        };
        reader.onerror = function () { alert('Erro ao ler o arquivo.'); };
        reader.readAsText(file, 'UTF-8');
    }
    
    window.onscroll = function() {
        const tableContainer = document.querySelector('.table-container');
        if (!scrollBtn || !tableContainer) return;
        const tableTopPosition = tableContainer.offsetTop;
        if (window.scrollY > tableTopPosition) {
            scrollBtn.textContent = "↑";
            scrollBtn.title = "Voltar ao topo";
            scrollBtn.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
            scrollBtn.textContent = "↓";
            scrollBtn.title = "Ir para a tabela";
            scrollBtn.onclick = () => tableContainer.scrollIntoView({ behavior: 'smooth' });
        }
    };

    async function carregarDados() { try { registros = await apiRequest('refugo'); applyAllFilters(); } catch (error) { console.error('Erro ao carregar dados:', error); updateUI([]); } }
    async function limparTodosDados() { if (confirm('Limpar TODOS os dados de refugo?')) { try { const ids = registros.filter(r => r.tipo === 'refugo').map(r => r.id); for (const id of ids) { await apiRequest('delete', 'POST', { id }); } registros = registros.filter(r => r.tipo !== 'refugo'); applyAllFilters(); alert('Dados de refugo removidos.'); } catch (error) { console.error('Erro ao limpar dados:', error); } } }
    
    document.addEventListener('DOMContentLoaded', ()=>{ 
        Chart.register(ChartDataLabels); 
        definirDataAtual(document.getElementById('inputData')); 
        setDefaultFilterDates(); 
        ['inputCodigo', 'inputDescricao', 'inputMaterial'].forEach(id => { document.getElementById(id).addEventListener('input', function() { this.value = this.value.toUpperCase(); }); }); 
        document.querySelectorAll('thead .filter-row input').forEach(input => { input.addEventListener('input', applyColumnFilters); });
        document.getElementById('csvFileInput').addEventListener('change', importCSV);
        carregarDados(); 
    });
</script>
</body>
</html>
